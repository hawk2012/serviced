import os
import getpass


def check_root():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –æ—Ç root."""
    if os.geteuid() != 0:
        print("–û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root.")
        exit(1)


def get_user_input(prompt, default=None):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–≤–æ–¥ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""
    if default:
        prompt = f"{prompt} (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {default}): "
    else:
        prompt = f"{prompt}: "

    user_input = input(prompt).strip()
    return user_input if user_input else default


def create_service_file(service_name, description, command, user, group, working_directory):
    """–°–æ–∑–¥–∞—ë—Ç .service —Ñ–∞–π–ª –≤ –∫–∞—Ç–∞–ª–æ–≥–µ systemd."""
    service_content = f"""[Unit]
Description={description}

[Service]
Type=simple
ExecStart={command}
User={user}
Group={group}
WorkingDirectory={working_directory}
Restart=always

[Install]
WantedBy=multi-user.target
"""

    service_path = f"/etc/systemd/system/{service_name}.service"

    try:
        with open(service_path, 'w') as f:
            f.write(service_content)
        print(f"‚úÖ –§–∞–π–ª —Å–µ—Ä–≤–∏—Å–∞ —Å–æ–∑–¥–∞–Ω: {service_path}")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞: {e}")
        return False


def main():
    print("üîß –°–æ–∑–¥–∞–Ω–∏–µ systemd-—Å–µ—Ä–≤–∏—Å–∞\n")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ root
    check_root()

    # –ü—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É systemd
    systemd_dir = "/etc/systemd/system"
    if not os.path.exists(systemd_dir):
        print(f"‚ùå –ö–∞—Ç–∞–ª–æ–≥ {systemd_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    service_name = get_user_input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)")
    description = get_user_input("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞", default=f"My {service_name} Service")
    command = get_user_input("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞", default="/usr/bin/python3 /home/user/my_script.py")
    user = get_user_input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", default=getpass.getuser())
    group = get_user_input("–í–≤–µ–¥–∏—Ç–µ –≥—Ä—É–ø–ø—É", default="www-data")
    working_directory = get_user_input("–í–≤–µ–¥–∏—Ç–µ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é", default=f"/home/{user}")

    # –í—ã–≤–æ–¥ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    print("\nüìÑ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞:")
    print(f"–ò–º—è —Å–µ—Ä–≤–∏—Å–∞: {service_name}")
    print(f"–û–ø–∏—Å–∞–Ω–∏–µ: {description}")
    print(f"–ö–æ–º–∞–Ω–¥–∞: {command}")
    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")
    print(f"–ì—Ä—É–ø–ø–∞: {group}")
    print(f"–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {working_directory}\n")

    confirm = input("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ (y/n): ").lower()
    if confirm != "y":
        print("‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ —Å–æ–∑–¥–∞–Ω.")
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if create_service_file(service_name, description, command, user, group, working_directory):
        print("\nüîÑ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:")
        print(f"sudo systemctl daemon-reload")
        print(f"sudo systemctl enable {service_name}")
        print(f"sudo systemctl start {service_name}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n‚ùå –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
